{% extends 'base.html' %} {% block title %}Conciertos{% endblock %} 
{% block content %}
<div class="w-full mx-auto p-8">
  <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
    <div class="flex flex-col gap-2">
      <h1
        class="text-white text-4xl font-black leading-tight tracking-[-0.033em]"
      >
        Conciertos
      </h1>
      {% if request.user.is_staff %}
      <p class="text-[#92a4c9] text-base font-normal leading-normal">
        Gestiona y organiza los conciertos en tu catálogo.
      </p>
        {% else %}
      <p class="text-[#92a4c9] text-base font-normal leading-normal">
        Explora y descubre conciertos de tus artistas favoritos.
      </p>
        {% endif %}
    </div>
    <div class="flex gap-2">
        <div class="flex items-center gap-8 w-[395px]">
          <form method="get" class="w-full">
            <label class="flex flex-col min-w-40 !h-10 w-full">
              <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                <div class="text-[#92a4c9] flex border-none bg-[#232f48] items-center justify-center pl-4 rounded-l-lg border-r-0 h-full">
                  <span class="material-symbols-outlined text-lg leading-none">search</span>
                </div>
                <input
                  name="query_concerts"
                  value="{{ request.GET.query_concerts|default_if_none:'' }}"
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-0 border-none bg-[#232f48] h-full placeholder:text-[#92a4c9] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                  placeholder="Buscar (Artista, Venue, Ciudad)"
                />
                <select name="status" onchange="this.form.submit()" class="ml-2 h-10 rounded-lg border-gray bg-[#232f48] text-white px-3 text-sm focus:ring-2 focus:ring-primary" aria-label="Filtrar por estado">
                  <option value="" {% if not selected_status %}selected{% endif %}>Todos</option>
                  {% for val,label in status_choices %}
                    <option value="{{ val }}" {% if selected_status == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </label>
          </form>
        </div>
    {% if request.user.is_staff %}
    <a href="{% url 'concert_add' %}">
    <button
      class="cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] truncate hover:bg-primary/50 transition-colors duration-200 ease-in-out"
    >
        Agregar Concierto
    </button>
    </a>
    {% endif %}
    </div>
  </div>
</div>


<div class="layout-content-container px-8 pb-8">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for concert in concerts %}
    <div
      class="relative group flex flex-col items-stretch justify-start rounded-xl shadow-[0_0_4px_rgba(0,0,0,0.1)] bg-[#192233] overflow-hidden transform transition-all duration-200 ease-out hover:scale-105 hover:-translate-y-1 hover:shadow-[0_12px_30px_rgba(255,255,255,0.06)]"
    >
      <div
        class="w-full bg-center bg-no-repeat aspect-[16/6] bg-cover transition-transform duration-200 transform group-hover:scale-105 h-[225px]"
        style="background-image: url('{{ concert.img }}');"
      ></div>
      {% if request.user.is_staff %}
        <!-- Delete button over the image (top-right of image) -->
        <form action="{% url 'concert_delete' concert.pk %}" method="post" onsubmit="return confirm('¿Eliminar este concierto? Esta acción borrará todos sus datos relacionados.');" class="absolute top-3 right-3 z-20">
          {% csrf_token %}
          <button type="submit" class="text-red-400 hover:text-white bg-transparent p-2 rounded-md shadow-sm hover:bg-white/5" aria-label="Eliminar concierto">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </form>
      {% else %}
        {% if concert.status == 'completed' %}
          <!-- Calificar button for completed concerts (top-right) -->
          <a href="{% url 'concert_detail' pk=concert.pk %}" class="absolute top-3 right-3 z-20 bg-primary/80 hover:bg-primary text-white px-3 py-2 rounded-md flex items-center gap-1" aria-label="Calificar concierto">
            <span class="ml-1">Calificar</span>
          </a>
        {% endif %}
      {% endif %}
      <div class="p-4 flex flex-col gap-4">
        <div class="flex w-full min-w-72 grow flex-col items-stretch justify-center gap-1">
          <div class="flex items-center gap-3 flex-wrap">
            <p class="text-white text-2xl font-bold leading-tight tracking-[-0.015em]">{{ concert.artist.name }}</p>
            {# Status badge #}
            {% if concert.status == 'scheduled' %}
              <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-500 text-white">Programado</span>
            {% elif concert.status == 'completed' %}
              <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-500 text-white">Realizado</span>
              <p class="text-green-500 text-base font-normal leading-normal"> Ventas: ${{ concert.total_income }}</p>
            {% elif concert.status == 'canceled' %}
              <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-500 text-white">Cancelado</span>
            {% else %}
              <span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-500 text-white">{{ concert.status }}</span>
            {% endif %}
            {# delete button moved to card corner (absolute) #}
          </div>
          <p class="text-[#92a4c9] text-base font-normal leading-normal">{{ concert.tour_name }}</p>
          <p class="text-white text-base font-normal leading-normal">{{ concert.start_datetime|date:"d/m/Y - H:i" }} - {{ concert.venue.name }}</p>
          <p class="text-white text-base font-normal leading-normal">{{ concert.venue.city }}</p>
        </div>
        <div class="flex justify-between items-center">
          <div class="flex items-center justify-center gap-3 py-2 pl-0">
              {% if not request.user.is_staff %}
                {% if request.user.is_authenticated and request.user.fan %}
                    {% if concert.pk in user_interested_ids %}
                      <button
                        data-concert-id="{{ concert.pk }}"
                        data-toggle-url="{% url 'toggle_interest' concert.pk %}"
                        data-count-url="{% url 'interest_count' concert.pk %}"
                        class="interest-toggle flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-2 text-sm font-bold leading-normal transition-colors duration-200 ease-in-out bg-yellow-500 text-white
                        hover:bg-yellow-600"
                        aria-pressed="true"
                      >
                        <span class="material-symbols-outlined interest-icon text-white" style="font-variation-settings: 'FILL' 1">star</span>
                        <p class="interest-label text-[13px] font-bold leading-normal tracking-[0.015em] pr-4 pl-1">Me interesa</p>
                      </button>
                    {% else %}
                      <button
                        data-concert-id="{{ concert.pk }}"
                        data-toggle-url="{% url 'toggle_interest' concert.pk %}"
                        data-count-url="{% url 'interest_count' concert.pk %}"
                        class="interest-toggle flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-2 text-sm font-bold leading-normal transition-colors duration-200 ease-in-out bg-primary text-white hover:bg-yellow-600"
                        aria-pressed="false"
                      >
                        <span class="material-symbols-outlined interest-icon text-[#FFE642]" style="font-variation-settings: 'FILL' 1">star</span>
                        <p class="interest-label text-[13px] font-bold leading-normal tracking-[0.015em] pr-4 pl-1">Me interesa</p>
                      </button>
                    {% endif %}
                {% else %}
                  <!-- invitación a iniciar sesión para marcar interés -->
                  <a href="{% url 'login' %}" class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-2 bg-primary text-white text-sm font-bold leading-normal hover:bg-primary/50 transition-colors duration-200 ease-in-out">
                    <span class="material-symbols-outlined text-[#FFE642]" style="font-variation-settings: 'FILL' 1">star</span>
                    <p class="text-[#92a4c9] text-[13px] font-bold leading-normal tracking-[0.015em] pr-4 pl-1">Me interesa</p>
                  </a>
                {% endif %}
              {% endif %}
              <!-- Mostrar botón 'Ver setlist' al lado del toggle para usuarios normales -->
              {% if not request.user.is_staff %}
                <a href="{% url 'concert_setlist' concert.pk %}" class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal hover:bg-primary/50 transition-colors duration-200 ease-in-out">
                  <span class="truncate">Ver setlist</span>
                </a>
              {% endif %}
              {% if not request.user.is_staff %}
              <div class="flex items-center justify-end pl-6">
                <span class="material-symbols-outlined text-[#FFA442]">local_fire_department</span>
              <p class="text-[#92a4c9] text-[13px] font-bold leading-normal tracking-[0.015em]"><span class="interest-count" data-concert-id="{{ concert.pk }}">{{ concert.interested.count }}</span> fans interesados</p>
              </div>
              {% else %}
              <div class="flex items-center">
                <span class="material-symbols-outlined text-[#FFA442]">local_fire_department</span>
              <p class="text-[#92a4c9] text-[13px] font-bold leading-normal tracking-[0.015em]"><span class="interest-count" data-concert-id="{{ concert.pk }}">{{ concert.interested.count }}</span> fans interesados</p>
              </div>
              {% endif %}


          </div>

          {% if request.user.is_staff %}
            <div class="flex gap-2">
              <a href="{% url 'concert_setlist' concert.pk %}">
                <button class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-2 bg-primary text-white text-sm font-bold leading-normal hover:bg-primary/50 transition-colors duration-200 ease-in-out">
                <span class="truncate">Editar setlist</span>
                </button>
              </a>
              </button>
              <a href="{% url 'concert_edit' concert.pk %}">
                <button class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-2 bg-primary text-white text-sm font-bold leading-normal hover:bg-primary/50 transition-colors duration-200 ease-in-out">
                <span class="truncate">Editar concierto</span>
              </button>
              </a>
            </div>
          {% endif %}
        </div>
        {# Rating moved to concert detail view; list should remain minimal. #}
      </div>
    </div>
    {% empty %}
    <div class="p-4 text-center col-span-2">
      <p class="text-[#92a4c9]">No hay conciertos disponibles</p>
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
<script>
// Delegated event handling + robust toggle for 'Me interesa'
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatCount(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1).replace(/\.0$/, '') + 'M';
  if (n >= 1000) return (n/1000).toFixed(1).replace(/\.0$/, '') + 'K';
  return n.toString();
}

document.addEventListener('DOMContentLoaded', function(){
  const csrftoken = getCookie('csrftoken');

  // Event delegation: handle clicks on any .interest-toggle, even if added later
  document.body.addEventListener('click', function(ev){
    const btn = ev.target.closest && ev.target.closest('.interest-toggle');
    if (!btn) return;
    ev.preventDefault();

    const url = btn.dataset.toggleUrl;
    const concertId = btn.dataset.concertId;
    if (!url || !concertId) {
      console.warn('missing toggle url or concert id', btn, url, concertId);
      return;
    }

    // optimistic UI change: flip visual state immediately
    const pressed = btn.getAttribute('aria-pressed') === 'true';
    // compute next state
    const nextPressed = !pressed;
    btn.setAttribute('aria-pressed', nextPressed.toString());
    if (nextPressed) {
      btn.classList.add('bg-yellow-500');
      btn.classList.remove('bg-primary');
      const icon = btn.querySelector('.interest-icon'); if (icon) icon.classList.add('text-white');
    } else {
      btn.classList.remove('bg-yellow-500');
      btn.classList.add('bg-primary');
      const icon = btn.querySelector('.interest-icon'); if (icon) icon.classList.remove('text-white');
    }

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    }).then(response => {
      if (response.status === 401 || response.status === 403) {
        // not authorized — redirect to login to make behavior clear
        window.location.href = '{% url "login" %}';
        return null;
      }
      return response.json().catch(err => { console.error('invalid json', err); return null; });
    }).then(data => {
      if (!data) return;
      if (data.status === 'ok') {
        const countEl = document.querySelector('.interest-count[data-concert-id="'+concertId+'"]');
        if (countEl) countEl.textContent = formatCount(data.count);
      } else {
        console.warn('toggle returned error', data);
      }
    }).catch(err => {
      console.error('toggle interest error', err);
    });
  });

  // Poll counts every 10s (adjust if necessary)
  setInterval(function(){
    document.querySelectorAll('.interest-count').forEach(function(el){
      const concertId = el.dataset.concertId;
      if (!concertId) return;
      const url = '/fans/concert/'+concertId+'/interest_count/';
      fetch(url, {credentials: 'same-origin'}).then(r=>r.json()).then(data=>{
        if (data && data.status === 'ok') {
          el.textContent = formatCount(data.count);
        }
      }).catch(()=>{});
    });
  }, 10000);

  // ----- Attendance (rating) UI -----
  // user_ratings_json is provided by the view (mapping concert_id -> rating)
  const userRatings = JSON.parse('{{ user_ratings_json|default:"{}"|escapejs }}');

  // populate attendance select options 1..10
  document.querySelectorAll('.attendance-select').forEach(function(sel){
    // avoid repopulating
    if (sel.dataset.populated) return;
    for (let i = 1; i <= 10; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      sel.appendChild(opt);
    }
    sel.dataset.populated = '1';
    const cid = sel.dataset.concertId;
    if (cid && userRatings && userRatings[cid] !== undefined && userRatings[cid] !== null) {
      sel.value = userRatings[cid];
    }
  });

  // handle click on rate buttons
  document.body.addEventListener('click', function(ev){
    const btn = ev.target.closest && ev.target.closest('.attendance-rate-btn');
    if (!btn) return;
    ev.preventDefault();
    const url = btn.dataset.rateUrl;
    const concertId = btn.dataset.concertId;
    const sel = document.querySelector('.attendance-select[data-concert-id="'+concertId+'"]');
    if (!sel) return;
    const rating = sel.value;
    if (!rating) {
      alert('Selecciona una puntuación entre 1 y 10.');
      return;
    }

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      credentials: 'same-origin',
      body: 'rating='+encodeURIComponent(rating)
    }).then(r=>r.json()).then(data=>{
      if (!data) return;
      if (data.status === 'ok') {
        // update avg display
        const avgEl = document.querySelector('.avg-rating[data-concert-id="'+concertId+'"]');
        if (avgEl) {
          avgEl.textContent = Number(data.avg).toFixed(1);
        }
      } else if (data.status === 'error') {
        alert(data.detail || 'Error al enviar la puntuación');
      }
    }).catch(err=>{ console.error('rate error', err); alert('Error comunicándose con el servidor.'); });
  });

});
</script>
{% endblock %}
